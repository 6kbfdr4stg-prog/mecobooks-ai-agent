<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mecobooks AI Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 6px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }

        .report-content h1 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .report-content h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .report-content h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 0.75rem;
        }

        .report-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.75rem 0;
            font-size: 0.8rem;
        }

        .report-content th,
        .report-content td {
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            text-align: left;
        }

        .report-content th {
            background: #f3f4f6;
            font-weight: 600;
        }

        .report-content tr:hover {
            background: #f9fafb;
        }

        .report-content ul,
        .report-content ol {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        .report-content li {
            margin-bottom: 0.25rem;
        }

        .report-content p {
            margin-bottom: 0.5rem;
        }

        .report-content pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.8rem;
        }

        .card {
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .report-item {
            cursor: pointer;
            transition: all 0.15s;
        }

        .report-item:hover {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .btn {
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: 500;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <div class="max-w-5xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-2">
                ü§ñ Mecobooks Admin Dashboard
            </h1>
            <p class="text-gray-500 mt-1">Qu·∫£n tr·ªã AI Agents ‚Ä¢ Xem b√°o c√°o ‚Ä¢ Ki·ªÉm tra h·ªá th·ªëng</p>
        </div>

        <!-- Section 1: Saved Reports -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">üìã B√°o c√°o ƒë√£ l∆∞u</h2>
                    <p class="text-sm text-gray-400">Xem l·∫°i c√°c b√°o c√°o t·ª´ AI Agent</p>
                </div>
                <button onclick="loadReports()" id="btn-load-reports"
                    class="btn bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 text-sm font-medium">
                    üîÑ T·∫£i b√°o c√°o
                </button>
            </div>
            <div id="reports-list" class="space-y-2"></div>
            <div id="reports-empty" class="hidden text-center text-gray-400 py-6 text-sm">
                Ch∆∞a c√≥ b√°o c√°o n√†o. H√£y ch·∫°y Agent tr∆∞·ªõc!
            </div>
        </div>

        <!-- Section 2: Run Agents -->
        <h2 class="text-lg font-semibold text-gray-700 mb-3">‚ö° Ch·∫°y Agent</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Content Creator -->
            <div class="card bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <div class="flex items-center gap-2 mb-1">
                    <span class="badge bg-purple-100 text-purple-700">Content</span>
                    <h3 class="font-semibold text-gray-800">‚úçÔ∏è Content Creator</h3>
                </div>
                <p class="text-xs text-gray-400 mb-3">Vi·∫øt caption, t·∫°o script video t·ª´ s·∫£n ph·∫©m</p>
                <button onclick="runAgent('content_creator')" id="btn-content_creator"
                    class="btn bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-medium">
                    ‚ñ∂ Run
                </button>
                <div id="res-content_creator"
                    class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-sm overflow-auto max-h-64 report-content"></div>
            </div>

            <!-- Market Research -->
            <div class="card bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <div class="flex items-center gap-2 mb-1">
                    <span class="badge bg-blue-100 text-blue-700">Research</span>
                    <h3 class="font-semibold text-gray-800">üìà Market Research</h3>
                </div>
                <p class="text-xs text-gray-400 mb-3">Nghi√™n c·ª©u trend s√°ch, xu·∫•t Google Sheets, ƒëƒÉng blog</p>
                <button onclick="runAgent('market_research')" id="btn-market_research"
                    class="btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium">
                    ‚ñ∂ Run
                </button>
                <div id="res-market_research"
                    class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-sm overflow-auto max-h-64 report-content"></div>
            </div>

            <!-- Inventory Analyst -->
            <div class="card bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <div class="flex items-center gap-2 mb-1">
                    <span class="badge bg-yellow-100 text-yellow-700">Inventory</span>
                    <h3 class="font-semibold text-gray-800">üì¶ Inventory Analyst</h3>
                </div>
                <p class="text-xs text-gray-400 mb-3">Ph√¢n t√≠ch t·ªìn kho ABC, l·∫≠p k·∫ø ho·∫°ch nh·∫≠p h√†ng</p>
                <button onclick="runAgent('inventory_analyst')" id="btn-inventory_analyst"
                    class="btn bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 text-sm font-medium">
                    ‚ñ∂ Run
                </button>
                <div id="res-inventory_analyst"
                    class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-sm overflow-auto max-h-64 report-content"></div>
            </div>

            <!-- Integrity Manager -->
            <div class="card bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <div class="flex items-center gap-2 mb-1">
                    <span class="badge bg-red-100 text-red-700">System</span>
                    <h3 class="font-semibold text-gray-800">üõ°Ô∏è Integrity Manager</h3>
                </div>
                <p class="text-xs text-gray-400 mb-3">Ki·ªÉm tra Disk, Memory, Server health</p>
                <button onclick="runAgent('integrity_manager')" id="btn-integrity_manager"
                    class="btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm font-medium">
                    ‚ñ∂ Run
                </button>
                <div id="res-integrity_manager"
                    class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-sm overflow-auto max-h-64 report-content"></div>
            </div>
        </div>

        <!-- Footer -->
        <p class="text-center text-xs text-gray-300 mt-8">Mecobooks AI System ¬© 2026</p>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-hidden mx-4"
            onclick="event.stopPropagation()">
            <div class="flex items-center justify-between px-6 py-4 border-b bg-gray-50">
                <div>
                    <h3 id="modal-title" class="font-semibold text-gray-800"></h3>
                    <p id="modal-date" class="text-xs text-gray-400"></p>
                </div>
                <button onclick="document.getElementById('report-modal').classList.remove('active')"
                    class="text-gray-400 hover:text-gray-600 text-xl font-bold px-2">‚úï</button>
            </div>
            <div id="modal-content" class="p-6 overflow-auto report-content" style="max-height: 70vh;"></div>
        </div>
    </div>

    <script>
        // Load saved reports
        async function loadReports() {
            const btn = document.getElementById('btn-load-reports');
            const list = document.getElementById('reports-list');
            const empty = document.getElementById('reports-empty');

            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> ƒêang t·∫£i...';

            try {
                const response = await fetch('/api/reports');
                const data = await response.json();

                if (!data.reports || data.reports.length === 0) {
                    list.innerHTML = '';
                    empty.classList.remove('hidden');
                    return;
                }

                empty.classList.add('hidden');

                const icons = {
                    'Market Research': 'üìà',
                    'Inventory Report': 'üì¶',
                    'Integrity Report': 'üõ°Ô∏è'
                };

                const colors = {
                    'Market Research': 'blue',
                    'Inventory Report': 'yellow',
                    'Integrity Report': 'red'
                };

                list.innerHTML = data.reports.map(r => {
                    const icon = icons[r.name] || 'üìÑ';
                    const color = colors[r.name] || 'gray';
                    return `
                        <div class="report-item border border-gray-200 rounded-lg p-3 flex items-center justify-between"
                             onclick="viewReport('${r.filename}', '${r.name}')">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${icon}</span>
                                <div>
                                    <p class="font-medium text-gray-800 text-sm">${r.name}</p>
                                    <p class="text-xs text-gray-400">C·∫≠p nh·∫≠t: ${r.modified} ‚Ä¢ ${r.size_kb} KB</p>
                                </div>
                            </div>
                            <span class="text-gray-300 text-lg">‚Üí</span>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                list.innerHTML = `<p class="text-red-500 text-sm">L·ªói: ${error.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ T·∫£i b√°o c√°o';
            }
        }

        // View a specific report in modal
        async function viewReport(filename, name) {
            const modal = document.getElementById('report-modal');
            const title = document.getElementById('modal-title');
            const date = document.getElementById('modal-date');
            const content = document.getElementById('modal-content');

            title.textContent = name;
            date.textContent = 'ƒêang t·∫£i...';
            content.innerHTML = '<div class="flex justify-center py-8"><span class="loader" style="border-top-color:#3b82f6; border-color:#e5e7eb; width:24px; height:24px;"></span></div>';
            modal.classList.add('active');

            try {
                const response = await fetch(`/api/reports/${filename}`);
                const data = await response.json();

                date.textContent = `C·∫≠p nh·∫≠t: ${data.modified}`;
                
                if (!data.content || data.content.trim() === '') {
                    content.innerHTML = '<div class="text-center py-8 text-gray-500 flex flex-col items-center"><span class="text-4xl mb-2">üì≠</span><p>B√°o c√°o n√†y ch∆∞a c√≥ n·ªôi dung.</p></div>';
                } else {
                    content.innerHTML = marked.parse(data.content);
                }
            } catch (error) {
                content.innerHTML = `<p class="text-red-500">L·ªói: ${error.message}</p>`;
            }
        }

        function closeModal(e) {
            if (e.target === e.currentTarget) {
                document.getElementById('report-modal').classList.remove('active');
            }
        }

        // Run an agent
        async function runAgent(agentName) {
            const btn = document.getElementById(`btn-${agentName}`);
            const res = document.getElementById(`res-${agentName}`);

            btn.disabled = true;
            const originalText = btn.innerText;
            btn.innerHTML = '<span class="loader"></span> Running...';
            res.classList.add('hidden');

            try {
                const response = await fetch(`/run-agent-sync/${agentName}`, { method: 'POST' });
                const data = await response.json();

                let outputHtml = '';
                const now = new Date().toLocaleString('vi-VN');

                if (data.status === 'success') {
                    outputHtml = `<p class="text-xs text-gray-400 mb-2">‚è± ${now}</p>`;
                    if (typeof data.output === 'string') {
                        outputHtml += marked.parse(data.output);
                    } else if (typeof data.output === 'object') {
                        if (data.output.content) {
                            outputHtml += marked.parse(data.output.content);
                        } else if (data.output.caption) {
                            outputHtml += `<strong>Caption:</strong><br>${data.output.caption.replace(/\n/g, '<br>')}<br><br><strong>Video Script:</strong><br>${data.output.video_script}`;
                            if (data.output.image_url) outputHtml += `<br><img src="${data.output.image_url}" class="mt-2 w-32">`;
                        } else {
                            outputHtml += `<pre>${JSON.stringify(data.output, null, 2)}</pre>`;
                        }
                    }
                } else {
                    outputHtml = `<span class="text-red-600">‚ùå ${data.message}</span>`;
                }

                res.innerHTML = outputHtml;
                res.classList.remove('hidden');

            } catch (error) {
                res.innerHTML = `<span class="text-red-600">‚ùå ${error.message}</span>`;
                res.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Auto-load reports on page load
        document.addEventListener('DOMContentLoaded', loadReports);
    </script>
</body>

</html>