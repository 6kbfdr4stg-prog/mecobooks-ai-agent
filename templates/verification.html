<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mecobooks AI Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 6px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }

        .report-content h1 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .report-content h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .report-content h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 0.75rem;
        }

        .report-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.75rem 0;
            font-size: 0.8rem;
        }

        .report-content th,
        .report-content td {
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            text-align: left;
        }

        .report-content th {
            background: #f3f4f6;
            font-weight: 600;
        }

        .report-content tr:hover {
            background: #f9fafb;
        }

        .report-content ul,
        .report-content ol {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        .report-content li {
            margin-bottom: 0.25rem;
        }

        .report-content p {
            margin-bottom: 0.5rem;
        }

        .report-content pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.8rem;
        }

        .card {
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .report-item {
            cursor: pointer;
            transition: all 0.15s;
        }

        .report-item:hover {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .btn {
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none !important;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex !important;
        }

        .badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: 500;
        }

        /* Mobile agent card fixes */
        @media (max-width: 640px) {
            .card {
                padding: 0.75rem !important;
            }

            .card h3 {
                font-size: 0.8rem !important;
                line-height: 1.2 !important;
            }

            .card .badge {
                font-size: 0.55rem !important;
                padding: 1px 5px !important;
            }

            .card .w-10 {
                width: 2rem !important;
                height: 2rem !important;
                font-size: 1rem !important;
            }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen font-sans bg-gradient-to-br from-indigo-50 via-white to-purple-50">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-64 bg-slate-900 text-white flex-col absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-300 ease-in-out z-50 md:flex shadow-2xl md:shadow-none">
            <div class="p-6 border-b border-gray-800 flex items-center gap-3">
                <span class="text-2xl">ü§ñ</span>
                <div>
                    <h1 class="font-bold text-lg tracking-wide">Mecobooks AI</h1>
                    <p class="text-xs text-gray-500">Admin Dashboard v2.2 - Scalability</p>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#"
                    class="flex items-center gap-3 px-4 py-3 bg-gray-800 text-white rounded-lg transition-colors">
                    <span>üìä</span> Overview
                </a>
                <a href="#agents"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <span>‚ö°</span> AI Agents
                </a>
                <a href="#reports"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <span>üìã</span> Reports
                </a>
                <a href="https://mecobooks.com/wp-admin" target="_blank"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <span>üõí</span> WordPress Admin
                </a>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <div id="server-status" class="flex items-center gap-2 text-xs text-gray-500">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    Server Online
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gray-50">
            <header
                class="bg-white border-b border-gray-200 px-8 py-4 flex justify-between items-center sticky top-0 z-10">
                <button id="mobile-menu-btn"
                    class="md:hidden text-gray-500 hover:text-gray-700 focus:outline-none focus:text-gray-700 flex items-center">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <h2 class="text-xl font-bold text-gray-800 ml-4 md:ml-0">Dashboard Overview</h2>
                <div class="flex items-center gap-4">
                    <button onclick="runInventorySync()" id="btn-global-sync"
                        class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:from-blue-700 hover:to-indigo-700 shadow-md shadow-blue-500/30 flex items-center gap-2 transform hover:scale-105 transition-all duration-300">
                        üì¶ Gi√°m s√°t Kho (Haravan)
                    </button>
                    <button onclick="loadStats()" class="text-gray-500 hover:text-gray-700 transition">
                        üîÑ Refresh
                    </button>
                    <div
                        class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold border border-blue-200">
                        A
                    </div>
                </div>
            </header>

            <div class="px-8 py-4 bg-yellow-50 border-b border-yellow-200 flex items-center gap-3 text-sm text-yellow-800"
                id="live-activity-bar">
                <span class="animate-pulse">üü¢</span>
                <span id="live-message">H·ªá th·ªëng s·∫µn s√†ng. Ch√†o m·ª´ng b·∫°n quay tr·ªü l·∫°i!</span>
            </div>

            <div class="px-8 py-8 max-w-7xl mx-auto space-y-8">

                <!-- KPI Section -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Revenue -->
                    <div
                        class="bg-white/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl shadow-indigo-100/40 border border-white text-gray-800">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Doanh thu (Th√°ng)
                                </p>
                                <h3 class="text-2xl font-bold text-gray-900 mt-1" id="kpi-revenue">---</h3>
                            </div>
                            <span class="p-2 bg-green-100 text-green-600 rounded-lg">üí∞</span>
                        </div>
                        <p class="text-xs text-green-600 flex items-center gap-1">
                            <span>‚Üë 12%</span> <span class="text-gray-400">vs th√°ng tr∆∞·ªõc</span>
                        </p>
                    </div>

                    <!-- Orders -->
                    <div
                        class="bg-white/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl shadow-indigo-100/40 border border-white text-gray-800">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">ƒê∆°n h√†ng m·ªõi</p>
                                <h3 class="text-2xl font-bold text-gray-900 mt-1" id="kpi-orders">---</h3>
                            </div>
                            <span class="p-2 bg-blue-100 text-blue-600 rounded-lg">üì¶</span>
                        </div>
                        <p class="text-xs text-gray-400">ƒê∆°n h√†ng ho√†n t·∫•t</p>
                    </div>

                    <!-- System Health (CPU) -->
                    <div
                        class="bg-white/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl shadow-indigo-100/40 border border-white text-gray-800">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">CPU Server</p>
                                <h3 class="text-2xl font-bold text-gray-900 mt-1" id="kpi-cpu">---%</h3>
                            </div>
                            <span class="p-2 bg-purple-100 text-purple-600 rounded-lg">üñ•Ô∏è</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                            <div class="bg-purple-500 h-1.5 rounded-full" id="bar-cpu" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- System Health (RAM) -->
                    <div
                        class="bg-white/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl shadow-indigo-100/40 border border-white text-gray-800">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">RAM Usage</p>
                                <h3 class="text-2xl font-bold text-gray-900 mt-1" id="kpi-ram">---%</h3>
                            </div>
                            <span class="p-2 bg-yellow-100 text-yellow-600 rounded-lg">üíæ</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                            <div class="bg-yellow-500 h-1.5 rounded-full" id="bar-ram" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div
                        class="bg-white/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl shadow-indigo-100/40 border border-white text-gray-800 col-span-2">
                        <h3 class="font-bold text-gray-800 mb-4">Bi·ªÉu ƒë·ªì Doanh thu (Demo)</h3>
                        <canvas id="salesChart" height="120"></canvas>
                    </div>
                    <div
                        class="bg-white/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl shadow-indigo-100/40 border border-white text-gray-800">
                        <h3 class="font-bold text-gray-800 mb-4">Tr·∫°ng th√°i T·ªìn kho (Demo)</h3>
                        <div class="relative h-48">
                            <canvas id="inventoryChart"></canvas>
                        </div>
                        <div class="mt-4 space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">C√≤n h√†ng</span>
                                <span class="font-medium text-gray-900">85%</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">H·∫øt h√†ng</span>
                                <span class="font-medium text-gray-900">15%</span>
                            </div>
                        </div>
                    </div>
                </div><!-- end charts grid -->

                <!-- BI Visual Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Revenue Chart -->
                    <div
                        class="bg-white/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl shadow-indigo-100/40 border border-white text-gray-800">
                        <h3 class="text-sm font-semibold text-gray-800 mb-6 flex items-center justify-between">
                            Doanh thu 30 ng√†y (VND)
                            <span class="text-emerald-500 text-xs font-normal">‚Üë TƒÉng tr∆∞·ªüng t·ªët</span>
                        </h3>
                        <div class="h-64 relative">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <!-- Inventory Chart -->
                    <div
                        class="bg-white/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl shadow-indigo-100/40 border border-white text-gray-800">
                        <h3 class="text-sm font-semibold text-gray-800 mb-6 flex items-center justify-between">
                            C∆° c·∫•u kho h√†ng (ABC Analysis)
                            <span class="text-blue-500 text-xs font-normal">Th√°ng hi·ªán t·∫°i</span>
                        </h3>
                        <div class="h-64 relative flex items-center justify-center">
                            <canvas id="inventoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Pricing Strategy Section (Phase 6) -->
                <div
                    class="bg-white/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl shadow-indigo-100/40 border border-white text-gray-800 mb-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">
                        üí∞ Chi·∫øn l∆∞·ª£c ƒë·ªãnh gi√° th√¥ng minh (2 T·∫ßng)
                    </h2>
                    <p class="text-xs text-gray-400 mb-5">T·∫ßng 1: Gi√° t·ªëi ∆∞u 30 ng√†y ƒë·∫ßu &nbsp;|&nbsp; T·∫ßng 2:
                        Gi√° tho√°t h√†ng n·∫øu ch∆∞a b√°n ƒë∆∞·ª£c</p>
                    <div class="flex flex-col md:flex-row gap-3 mb-5">
                        <input type="text" id="pricing-input"
                            class="flex-1 p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="Nh·∫≠p t√™n s√°ch (VD: Nh√† gi·∫£ kim, ƒê·∫Øc nh√¢n t√¢m...)">
                        <select id="pricing-category"
                            class="p-3 border border-gray-200 rounded-lg text-sm text-gray-600 outline-none">
                            <option value="default">üìö Th·ªÉ lo·∫°i chung</option>
                            <option value="van-hoc">üìñ VƒÉn h·ªçc</option>
                            <option value="lich-su">üèõÔ∏è L·ªãch s·ª≠</option>
                            <option value="kinh-te">üíπ Kinh t·∫ø</option>
                            <option value="khoa-hoc">üî¨ Khoa h·ªçc</option>
                            <option value="self-help">üßò Self-help</option>
                            <option value="thieu-nhi">üß∏ Thi·∫øu nhi</option>
                            <option value="chuyen-nganh">üéì Chuy√™n ng√†nh</option>
                        </select>
                        <button onclick="calcPricing()" id="btn-calc-pricing"
                            class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-3 rounded-xl hover:from-indigo-700 hover:to-purple-700 font-bold transition-all duration-300 transform hover:scale-105 shadow-xl shadow-indigo-500/30 flex items-center justify-center gap-2">
                            <span>üßÆ</span> T√≠nh gi√°
                        </button>
                    </div>
                    <!-- Mode Badge -->
                    <div id="pricing-mode-badge" class="hidden mb-4 px-4 py-2 rounded-lg text-sm font-medium">
                    </div>

                    <!-- Pricing Result Cards (hidden by default) -->
                    <div id="pricing-result" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Tier 1 -->
                            <div class="border-2 border-indigo-200 bg-indigo-50 rounded-xl p-5">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-xs font-bold text-indigo-600 uppercase tracking-wider">T·∫ßng
                                        1 ¬∑ 30 Ng√†y ƒë·∫ßu</span>
                                    <span class="text-xs text-indigo-400" id="pricing-tier1-ratio"></span>
                                </div>
                                <div class="text-3xl font-extrabold text-indigo-700 my-2" id="pricing-tier1-price">---
                                </div>
                                <div class="text-sm text-indigo-600" id="pricing-tier1-label">Gi√° C·∫°nh Tranh
                                </div>
                                <div class="text-xs text-gray-500 mt-2" id="pricing-tier1-strategy"></div>
                            </div>
                            <!-- Tier 2 -->
                            <div class="border-2 border-orange-200 bg-orange-50 rounded-xl p-5">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-xs font-bold text-orange-600 uppercase tracking-wider">T·∫ßng
                                        2 ¬∑ Tho√°t kho</span>
                                    <span class="text-xs text-orange-400" id="pricing-tier2-ratio"></span>
                                </div>
                                <div class="text-3xl font-extrabold text-orange-600 my-2" id="pricing-tier2-price">---
                                </div>
                                <div class="text-sm text-orange-600" id="pricing-tier2-label">Gi√° Thanh L√Ω</div>
                                <div class="text-xs text-gray-500 mt-2">√Åp d·ª•ng sau 30 ng√†y n·∫øu ch∆∞a b√°n ƒë∆∞·ª£c
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 text-sm text-gray-600 border border-gray-100"
                            id="pricing-recommendation"></div>
                        <!-- Lower Actions & History -->
                        <div class="flex flex-wrap gap-4 pt-4 border-t border-gray-100">
                            <button onclick="applyMarkdowns(true)"
                                class="bg-white text-gray-700 border border-gray-300 px-5 py-2.5 rounded-lg hover:bg-gray-50 text-sm font-medium transition-all flex items-center gap-2">
                                üîç Xem tr∆∞·ªõc h√†ng c·∫ßn gi·∫£m gi√° (Tier 2)
                            </button>
                            <button onclick="applyMarkdowns(false)"
                                class="bg-orange-50 text-orange-700 border border-orange-200 px-5 py-2.5 rounded-lg hover:bg-orange-100 text-sm font-medium transition-all flex items-center gap-2">
                                ‚ö° √Åp d·ª•ng gi·∫£m gi√° T·∫ßng 2 ngay
                            </button>
                            <button onclick="loadPricingHistory()"
                                class="bg-white text-indigo-600 border border-indigo-200 px-5 py-2.5 rounded-lg hover:bg-indigo-50 text-sm font-medium transition-all flex items-center gap-2 ml-auto">
                                üìú Xem l·ªãch s·ª≠ ƒë·ªïi gi√°
                            </button>
                        </div>

                        <!-- Markdown Results Area -->
                        <div id="markdown-result" class="hidden mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                            <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                üìù K·∫øt qu·∫£ x·ª≠ l√Ω h√†ng t·ªìn
                            </h3>
                            <div id="markdown-list" class="space-y-2 max-h-60 overflow-y-auto pr-2 text-xs">
                            </div>
                        </div>

                        <!-- Pricing History Modal/Section -->
                        <div id="pricing-history-section" class="hidden mt-6 pt-6 border-t border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                    üìú Nh·∫≠t k√Ω thay ƒë·ªïi t·∫ßng gi√° (Pricing History)
                                </h3>
                                <button
                                    onclick="document.getElementById('pricing-history-section').classList.add('hidden')"
                                    class="text-gray-400 hover:text-gray-600">‚úï</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-xs">
                                    <thead>
                                        <tr class="text-gray-400 border-b border-gray-100">
                                            <th class="pb-2 font-medium">Th·ªùi gian</th>
                                            <th class="pb-2 font-medium">S·∫£n ph·∫©m</th>
                                            <th class="pb-2 font-medium">L·ªô tr√¨nh</th>
                                            <th class="pb-2 font-medium">Gi√° c≈©</th>
                                            <th class="pb-2 font-medium">Gi√° m·ªõi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pricing-history-list" class="divide-y divide-gray-50">
                                        <!-- Rows dynamic -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Markdown Result -->


                    <div id="pricing-empty" class="py-10 text-center text-gray-400">
                        <div class="text-4xl mb-2 opacity-30">üí∞</div>
                        <p>Nh·∫≠p t√™n s√°ch ƒë·ªÉ nh·∫≠n g·ª£i √Ω gi√° chi·∫øn l∆∞·ª£c 2 t·∫ßng.</p>
                    </div>
                    <div id="pricing-loading" class="hidden py-10 text-center">
                        <div
                            class="inline-block animate-spin rounded-full h-7 w-7 border-4 border-indigo-100 border-t-indigo-600 mb-3">
                        </div>
                        <p class="text-gray-500">ƒêang t√¨m gi√° th·ªã tr∆∞·ªùng v√† t√≠nh to√°n...</p>
                    </div>
                </div>

                <!-- Smart Bundling Section (Phase 7) -->
                <div
                    class="bg-white/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl shadow-indigo-100/40 border border-white text-gray-800 mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            üì¶ Smart Bundling (Combo D·ªçn Kho)
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="syncBundles()" id="btn-sync-bundles"
                                class="text-xs bg-orange-50 text-orange-600 px-3 py-1.5 rounded-lg hover:bg-orange-100 font-medium transition-all flex items-center gap-1">
                                üîÑ ƒê·ªìng b·ªô t·ªìn kho
                            </button>
                            <button onclick="loadBundleSuggestions()" id="btn-load-bundles"
                                class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-100 font-medium transition-all">
                                ‚ú® Qu√©t c∆° h·ªôi Combo
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mb-5">Gh√©p c√°c cu·ªën s√°ch t·ªìn kho (Tier 2) c√πng th·ªÉ lo·∫°i
                        th√†nh g√≥i Combo ƒë·ªÉ thanh l√Ω nhanh g·∫•p 2 l·∫ßn.</p>

                    <div id="bundle-suggestions-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Dynamic Bundle Cards -->
                        <div
                            class="col-span-full py-10 text-center text-gray-300 border-2 border-dashed border-gray-100 rounded-xl">
                            Nh·∫•n "Qu√©t c∆° h·ªôi" ƒë·ªÉ t√¨m c√°c b·ªô s√°ch c√πng th·ªÉ lo·∫°i ƒëang t·ªìn kho.
                        </div>
                    </div>

                    <div id="bundle-loading" class="hidden py-10 text-center">
                        <div class="animate-spin text-4xl mb-2">üì¶</div>
                        <p class="text-sm text-gray-400">ƒêang ph√¢n t√≠ch kho h√†ng Tier 2...</p>
                    </div>
                </div>

                <!-- Price Scout Section (Phase 5) -->
                <div
                    class="bg-white/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl shadow-indigo-100/40 border border-white text-gray-800 mb-8">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        üîç Price Scout - So s√°nh gi√° th·ªã tr∆∞·ªùng
                    </h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <input type="text" id="price-search-input"
                            class="flex-1 p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                            placeholder="Nh·∫≠p t√™n s√°ch c·∫ßn so s√°nh gi√° (V√≠ d·ª•: Nh√† gi·∫£ kim)...">
                        <button onclick="scoutPrice()" id="btn-scout-price"
                            class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-3 rounded-xl hover:from-blue-700 hover:to-indigo-700 font-bold transition-all duration-300 transform hover:scale-105 shadow-xl shadow-blue-500/30 flex items-center justify-center gap-2">
                            <span>üöÄ</span> So s√°nh ngay
                        </button>
                    </div>

                    <!-- Search Results -->
                    <div id="price-results" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="border-b border-gray-100">
                                        <th class="py-3 px-4 text-xs font-semibold text-gray-500 uppercase">N·ªÅn
                                            t·∫£ng</th>
                                        <th class="py-3 px-4 text-xs font-semibold text-gray-500 uppercase">S·∫£n
                                            ph·∫©m</th>
                                        <th class="py-3 px-4 text-xs font-semibold text-gray-500 uppercase text-right">
                                            Gi√° ti·ªÅn</th>
                                        <th class="py-3 px-4 text-xs font-semibold text-gray-500 uppercase text-right">
                                            H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody id="price-results-body">
                                    <!-- Dynamic content here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty/Loading State -->
                    <div id="price-scout-empty" class="py-12 text-center text-gray-400">
                        <div class="text-5xl mb-3 grayscale opacity-30">üìö</div>
                        <p>Nh·∫≠p t√™n s√°ch ƒë·ªÉ b·∫Øt ƒë·∫ßu so s√°nh gi√° t·ª´ Tiki, Fahasa v√† Oreka.</p>
                    </div>
                    <div id="price-scout-loading" class="hidden py-12 text-center">
                        <div
                            class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-100 border-t-blue-600 mb-4">
                        </div>
                        <p class="text-gray-500">ƒêang l√πng s·ª•c gi√° t·ªët tr√™n c√°c s√†n...</p>
                    </div>
                </div>

                <!-- Live Agent Activity -->
                <div id="agents">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        ‚ö° Control Center - AI Agents
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-3 sm:gap-4">
                        <!-- Content Creator -->
                        <div
                            class="card bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl shadow-indigo-100/20 border border-white/60 p-5 hover:border-purple-400 hover:shadow-purple-200/40 transition-all duration-300 group hover:-translate-y-1">
                            <div class="flex justify-between items-start mb-3">
                                <div
                                    class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center text-xl">
                                    ‚úçÔ∏è</div>
                                <span class="badge bg-green-50 text-green-700 border border-green-100">Ready</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1 group-hover:text-purple-600 transition-colors">
                                Content Creator</h3>
                            <p class="text-xs text-gray-500 mb-3 leading-relaxed">Vi·∫øt caption, t·∫°o script video t·ª´ s·∫£n
                                ph·∫©m</p>

                            <button onclick="runAgent('content_creator')" id="btn-content_creator"
                                class="w-full btn bg-gray-900 text-white px-2 py-2 rounded-xl hover:bg-black text-xs sm:text-sm font-semibold flex justify-center gap-1.5 transition-all">
                                <span>‚ñ∂</span><span class="hidden sm:inline">Run</span> Agent
                            </button>
                            <div id="res-content_creator"
                                class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-40 report-content border border-gray-100">
                            </div>
                        </div>

                        <!-- Market Research -->
                        <div
                            class="card bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl shadow-indigo-100/20 border border-white/60 p-5 hover:border-blue-400 hover:shadow-blue-200/40 transition-all duration-300 group hover:-translate-y-1">
                            <div class="flex justify-between items-start mb-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-xl">
                                    üìà</div>
                                <span class="badge bg-green-50 text-green-700 border border-green-100">Ready</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1 group-hover:text-blue-600 transition-colors">
                                Market
                                Research</h3>
                            <p class="text-xs text-gray-500 mb-3 leading-relaxed">Nghi√™n c·ª©u trend s√°ch, ƒëƒÉng Blog t·ª±
                                ƒë·ªông</p>

                            <button onclick="runAgent('market_research')" id="btn-market_research"
                                class="w-full btn bg-gray-900 text-white px-2 py-2 rounded-xl hover:bg-black text-xs sm:text-sm font-semibold flex justify-center gap-1.5 transition-all">
                                <span>‚ñ∂</span><span class="hidden sm:inline">Run</span> Agent
                            </button>
                            <div id="res-market_research"
                                class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-40 report-content border border-gray-100">
                            </div>
                        </div>

                        <!-- Inventory Analyst -->
                        <div
                            class="card bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl shadow-indigo-100/20 border border-white/60 p-5 hover:border-yellow-400 hover:shadow-yellow-200/40 transition-all duration-300 group hover:-translate-y-1">
                            <div class="flex justify-between items-start mb-3">
                                <div
                                    class="w-10 h-10 rounded-lg bg-yellow-100 flex items-center justify-center text-xl">
                                    üìä</div>
                                <span class="badge bg-green-50 text-green-700 border border-green-100">Ready</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1 group-hover:text-yellow-600 transition-colors">
                                Ph√¢n t√≠ch T·ªìn kho (ABC)</h3>
                            <p class="text-xs text-gray-500 mb-3 leading-relaxed">Ph√¢n lo·∫°i h√†ng h√≥a ABC & k·∫ø ho·∫°ch nh·∫≠p
                                h√†ng</p>

                            <button onclick="runAgent('inventory_analyst')" id="btn-inventory_analyst"
                                class="w-full btn bg-gray-900 text-white px-2 py-2 rounded-xl hover:bg-black text-xs sm:text-sm font-semibold flex justify-center gap-1.5 transition-all">
                                <span>‚ñ∂</span><span class="hidden sm:inline">Run</span> Agent
                            </button>
                            <div id="res-inventory_analyst"
                                class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-40 report-content border border-gray-100">
                            </div>
                        </div>

                        <!-- Integrity Manager -->
                        <div
                            class="card bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl shadow-indigo-100/20 border border-white/60 p-5 hover:border-red-400 hover:shadow-red-200/40 transition-all duration-300 group hover:-translate-y-1">
                            <div class="flex justify-between items-start mb-3">
                                <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center text-xl">
                                    üõ°Ô∏è</div>
                                <span class="badge bg-green-50 text-green-700 border border-green-100">Ready</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1 group-hover:text-red-600 transition-colors">
                                Integrity Manager</h3>
                            <p class="text-xs text-gray-500 mb-3 leading-relaxed">Ki·ªÉm tra Disk, Memory & Server health
                            </p>

                            <button onclick="runAgent('integrity_manager')" id="btn-integrity_manager"
                                class="w-full btn bg-gray-900 text-white px-2 py-2 rounded-xl hover:bg-black text-xs sm:text-sm font-semibold flex justify-center gap-1.5 transition-all">
                                <span>‚ñ∂</span><span class="hidden sm:inline">Run</span> Agent
                            </button>
                            <div id="res-integrity_manager"
                                class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-40 report-content border border-gray-100">
                            </div>
                        </div>

                        <!-- BI Analyst Agent (BI UPGRADE) -->
                        <div
                            class="card bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl shadow-emerald-100/20 border border-emerald-200 p-5 hover:border-emerald-400 hover:shadow-emerald-200/40 transition-all duration-300 group hover:-translate-y-1 ring-2 ring-emerald-50 ring-offset-2">
                            <div class="flex justify-between items-start mb-3">
                                <div
                                    class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center text-xl">
                                    üìà</div>
                                <span class="badge bg-emerald-50 text-emerald-700 border border-emerald-100">NEW</span>
                            </div>
                            <h3 class="font-bold text-emerald-800 mb-1">BI Analyst Agent</h3>
                            <p class="text-xs text-gray-500 mb-4 h-8 overflow-hidden">T·ªïng h·ª£p doanh thu & G·ª≠i
                                b√°o c√°o Telegram 8:00 m·ªói ng√†y</p>

                            <button onclick="runAgent('bi_analyst')" id="btn-bi_analyst"
                                class="w-full btn bg-emerald-600 text-white px-4 py-2.5 rounded-lg hover:bg-emerald-700 text-sm font-medium flex justify-center gap-2">
                                <span>‚ñ∂</span> Run BI Report
                            </button>
                            <div id="res-bi_analyst"
                                class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-40 report-content border border-gray-100">
                            </div>
                        </div>

                        <!-- Inventory Ops -->
                        <div
                            class="card bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl shadow-blue-100/20 border border-blue-200 p-5 hover:border-blue-400 hover:shadow-blue-200/40 transition-all duration-300 group hover:-translate-y-1 ring-2 ring-blue-50 ring-offset-2">
                            <div class="flex justify-between items-start mb-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-xl">
                                    üîÑ</div>
                                <span class="badge bg-blue-50 text-blue-700 border border-blue-100 italic">Core
                                    Sync</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1 group-hover:text-blue-600 transition-colors">
                                Gi√°m s√°t Kho (Haravan)</h3>
                            <p class="text-xs text-gray-500 mb-3 leading-relaxed">Theo d√µi t·ªìn kho & c·∫£nh b√°o t·ª´ Haravan
                            </p>

                            <button onclick="runInventorySync()" id="btn-inventory_ops"
                                class="w-full btn bg-blue-600 text-white px-4 py-2.5 rounded-lg hover:bg-blue-700 text-sm font-medium flex justify-center gap-2">
                                <span>üöÄ</span> Run Monitor
                            </button>
                            <div id="res-inventory_ops"
                                class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-40 report-content border border-gray-100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports"
                    class="bg-white/70 backdrop-blur-xl rounded-3xl shadow-xl shadow-indigo-100/40 border border-white p-6 text-gray-800">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">üìã B√°o c√°o ƒë√£ l∆∞u</h2>
                            <p class="text-sm text-gray-400">L·ªãch s·ª≠ ho·∫°t ƒë·ªông c·ªßa c√°c Agent</p>
                        </div>
                        <button onclick="loadReports()" id="btn-load-reports"
                            class="btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium border border-gray-200">
                            üîÑ T·∫£i l·∫°i
                        </button>
                    </div>

                    <div id="reports-list" class="space-y-3"></div>
                    <div id="reports-empty"
                        class="hidden text-center text-gray-400 py-12 text-sm bg-gray-50 rounded-lg border border-dashed border-gray-200">
                        <span class="text-4xl block mb-2">üì≠</span>
                        Ch∆∞a c√≥ b√°o c√°o n√†o. H√£y ch·∫°y Agent ·ªü tr√™n!
                    </div>
                </div>
            </div>

            <footer class="text-center text-xs text-gray-400 py-8 border-t border-gray-200 mt-8">
                Mecobooks AI System v2.1 ¬© 2026 ‚Ä¢ Powered by Antigravity
            </footer>
        </main>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden mx-4 flex flex-col"
            onclick="event.stopPropagation()">
            <div class="flex items-center justify-between px-6 py-4 border-b bg-gray-50 shrink-0">
                <div class="flex-1">
                    <h3 id="modal-title" class="font-bold text-gray-900 text-lg"></h3>
                    <p id="modal-date" class="text-xs text-gray-500"></p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btn-gen-video"
                        class="hidden bg-purple-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-purple-700 transition flex items-center gap-2">
                        üéûÔ∏è T·∫°o Video TikTok/Reels
                    </button>
                    <button onclick="document.getElementById('report-modal').classList.remove('active')"
                        class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 hover:bg-gray-300 flex items-center justify-center transition">‚úï</button>
                </div>
            </div>
            <div id="modal-content" class="p-8 overflow-auto report-content flex-1 max-h-[80vh]"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>

        // Mobile menu toggle
        const btn = document.querySelector('#mobile-menu-btn');
        const sidebar = document.querySelector('#sidebar');
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            sidebar.classList.toggle('-translate-x-full');
        });
        document.addEventListener('click', (e) => {
            if (!sidebar.contains(e.target) && !sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
            }
        });

        // --- 1. Stats & Charts Logic ---

        // --- 1. BI Charts Logic ---
        let revenueChartInstance = null;
        let inventoryChartInstance = null;

        function updateCharts(biData) {
            console.log("Updating Charts with:", biData);

            // 1. Revenue Line Chart
            const revCanvas = document.getElementById('revenueChart');
            if (revCanvas) {
                const labels = Object.keys(biData.daily_revenue || {}).sort();
                const values = labels.map(l => biData.daily_revenue[l]);

                if (revenueChartInstance) revenueChartInstance.destroy();
                revenueChartInstance = new Chart(revCanvas, {
                    type: 'line',
                    data: {
                        labels: labels.map(l => l.split('-').slice(1).join('/')), // MM/DD
                        datasets: [{
                            label: 'Doanh thu (VND)',
                            data: values,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { font: { size: 10 } } },
                            x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                        }
                    }
                });
            }

            // 2. Inventory Distribution Chart
            const invCanvas = document.getElementById('inventoryChart');
            if (invCanvas) {
                if (inventoryChartInstance) inventoryChartInstance.destroy();
                inventoryChartInstance = new Chart(invCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Nh√≥m A (Hot)', 'Nh√≥m B (Th∆∞·ªùng)', 'Nh√≥m C (T·ªìn)'],
                        datasets: [{
                            data: [biData.inventory?.a || 0, biData.inventory?.b || 0, biData.inventory?.c || 0],
                            backgroundColor: ['#10b981', '#3b82f6', '#f59e0b'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 10 } } } }
                    }
                });
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                if (data.business) {
                    const revStr = parseInt(data.business.sales_total || 0).toLocaleString('vi-VN');
                    document.getElementById('sales-total').textContent = revStr + ' ‚Ç´';
                    document.getElementById('orders-count').textContent = data.business.orders_count || 0;
                    document.getElementById('customers-count').textContent = data.business.new_customers || 0;

                    if (data.business.bi) {
                        updateCharts(data.business.bi);
                    }
                }

                if (data.system) {
                    document.getElementById('cpu-usage').textContent = (data.system.cpu || 0) + '%';
                    document.getElementById('mem-usage').textContent = (data.system.memory || 0) + '%';
                    document.getElementById('disk-usage').textContent = (data.system.disk || 0) + '%';
                }
            } catch (err) {
                console.error("Stats Error:", err);
            }
        }

        // --- 2. Existing Reports & Agents Logic ---

        async function loadReports() {
            const btn = document.getElementById('btn-load-reports');
            const list = document.getElementById('reports-list');
            const empty = document.getElementById('reports-empty');

            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> ...';

            try {
                const response = await fetch('/api/reports');
                const data = await response.json();

                if (!data.reports || data.reports.length === 0) {
                    list.innerHTML = '';
                    empty.classList.remove('hidden');
                    return;
                }

                empty.classList.add('hidden');

                const icons = { 'Market Research': 'üìà', 'Inventory Report': 'üì¶', 'Integrity Report': 'üõ°Ô∏è' };
                const colors = { 'Market Research': 'blue', 'Inventory Report': 'yellow', 'Integrity Report': 'red' }; // Unused but kept for logic

                list.innerHTML = data.reports.map(r => {
                    const icon = icons[r.name] || 'üìÑ';
                    const color = colors[r.name] || 'gray';
                    return `
                        <div class="report-item bg-gray-50 border border-gray-100 rounded-lg p-4 flex items-center justify-between hover:bg-white hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group"
                             onclick="viewReport('${r.id}', '${r.name}')">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-xl shadow-sm group-hover:scale-110 transition-transform">${icon}</div>
                                <div>
                                    <p class="font-bold text-gray-800 text-sm group-hover:text-blue-600 transition-colors">${r.name}</p>
                                    <p class="text-xs text-gray-400">ID: ${r.id} ‚Ä¢ C·∫≠p nh·∫≠t: ${r.modified} ‚Ä¢ ${r.size_kb} KB</p>
                                </div>
                            </div>
                            <span class="text-gray-300 text-lg group-hover:text-blue-500 transition-colors">View ‚Üí</span>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                list.innerHTML = `<p class="text-red-500 text-sm">L·ªói: ${error.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ T·∫£i l·∫°i';
            }
        }

        let currentReportId = null;

        async function viewReport(reportId, name) {
            const modal = document.getElementById('report-modal');
            const title = document.getElementById('modal-title');
            const date = document.getElementById('modal-date');
            const content = document.getElementById('modal-content');

            currentReportId = reportId;
            title.textContent = name;
            date.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu...';

            // Handle Video Button
            const btnGen = document.getElementById('btn-gen-video');
            if (btnGen) {
                btnGen.classList.add('hidden');
                btnGen.innerHTML = 'üéûÔ∏è T·∫°o Video TikTok/Reels';
                btnGen.classList.remove('bg-green-600');
                btnGen.classList.add('bg-purple-600');
                btnGen.disabled = false;
                btnGen.classList.remove('opacity-50', 'cursor-not-allowed');
                btnGen.onclick = () => generateVideo(reportId);
            }

            content.innerHTML = '<div class="flex justify-center py-12"><span class="loader" style="width: 32px; height: 32px; border-width: 4px; border-color: #e5e7eb; border-top-color: #3b82f6;"></span></div>';
            modal.classList.add('active');

            try {
                const response = await fetch(`/api/reports/${reportId}`);
                const data = await response.json();

                date.textContent = `ID: ${reportId} ‚Ä¢ C·∫≠p nh·∫≠t: ${data.modified}`;

                if (!data.content || data.content.trim() === '') {
                    content.innerHTML = '<div class="text-center py-12 text-gray-400 flex flex-col items-center"><span class="text-5xl mb-3 grayscale opacity-50">üìÑ</span><p>B√°o c√°o n√†y ch∆∞a c√≥ n·ªôi dung.</p></div>';
                } else {
                    content.innerHTML = marked.parse(data.content);

                    // Show Video Button if it's a Content Creator report
                    if (name.toLowerCase().includes('content') && btnGen) {
                        btnGen.classList.remove('hidden');
                    }
                }
            } catch (error) {
                content.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-lg">‚ùå L·ªói: ${error.message}</div>`;
            }
        }

        async function generateVideo(reportId) {
            const btn = document.getElementById('btn-gen-video');
            if (!btn) return;

            if (!confirm('B·∫Øt ƒë·∫ßu t·∫°o Video t·ª´ k·ªãch b·∫£n n√†y? Qu√° tr√¨nh x·ª≠ l√Ω m·∫•t kho·∫£ng 30-60 gi√¢y.')) return;

            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.innerHTML = '<span class="loader"></span> ƒêang t·∫°o...';

            try {
                const response = await fetch(`/api/generate-video/${reportId}`, { method: 'POST' });
                const data = await response.json();

                if (data.status === 'success') {
                    btn.innerHTML = '‚úÖ Video Xong!';
                    btn.classList.remove('bg-purple-600');
                    btn.classList.add('bg-green-600');

                    // Show link in modal
                    const videoDiv = document.createElement('div');
                    videoDiv.className = 'mt-6 p-4 bg-green-50 border border-green-200 rounded-xl flex flex-col items-center gap-3';
                    videoDiv.innerHTML = `
                        <p class="text-green-800 font-bold text-sm">üéâ Video ƒë√£ ƒë∆∞·ª£c t·∫°o v√† g·ª≠i qua Telegram!</p>
                        <video controls class="w-full max-w-sm rounded-lg shadow-lg">
                            <source src="${data.video_url}" type="video/mp4">
                        </video>
                        <a href="${data.video_url}" target="_blank" class="text-blue-600 underline text-xs">M·ªü video trong tab m·ªõi</a>
                    `;
                    document.getElementById('modal-content').prepend(videoDiv);

                } else {
                    alert('L·ªói: ' + data.message);
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = originalHtml;
                }
            } catch (error) {
                alert('Connection Error: ' + error.message);
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerHTML = originalHtml;
            }
        }

        function closeModal(e) {
            if (e.target === e.currentTarget) {
                document.getElementById('report-modal').classList.remove('active');
                // Cleanup video button
                const btn = document.getElementById('btn-gen-video');
                if (btn) btn.remove();
            }
        }

        async function runAgent(agentName) {
            const btn = document.getElementById(`btn-${agentName}`);
            const res = document.getElementById(`res-${agentName}`);

            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loader"></span> Processing...';
            res.classList.add('hidden');

            try {
                const response = await fetch(`/run-agent-sync/${agentName}`, { method: 'POST' });
                const data = await response.json();

                let outputHtml = '';
                const now = new Date().toLocaleString('vi-VN');

                if (data.status === 'success') {
                    outputHtml = `<p class="text-green-600 font-bold mb-2 text-xs">‚úÖ Success ‚Ä¢ ${now}</p>`;
                    if (typeof data.output === 'string') {
                        outputHtml += marked.parse(data.output);
                    } else if (typeof data.output === 'object') {
                        outputHtml += `<pre class="text-xs bg-gray-100 p-2 rounded">${JSON.stringify(data.output, null, 2)}</pre>`;
                    }
                    // Auto reload stats and reports if agent succeeds (likely updated something)
                    setTimeout(() => { loadStats(); loadReports(); }, 2000);
                } else {
                    outputHtml = `<span class="text-red-600 font-bold">‚ùå Error: ${data.message}</span>`;
                }

                res.innerHTML = outputHtml;
                res.classList.remove('hidden');

            } catch (error) {
                res.innerHTML = `<span class="text-red-600 font-bold">‚ùå Network Error: ${error.message}</span>`;
                res.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function runInventorySync() {
            const btn = document.getElementById('btn-inventory_ops');
            const gBtn = document.getElementById('btn-global-sync');
            const res = document.getElementById('res-inventory_ops');

            const originalText = btn.innerHTML;
            const originalGText = gBtn.innerHTML;

            btn.disabled = true;
            gBtn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> Syncing...';
            gBtn.innerHTML = '<span class="loader"></span> ...';

            try {
                const response = await fetch('/api/run-inventory-sync', { method: 'POST' });
                const data = await response.json();

                if (data.status === 'success') {
                    alert('‚úÖ ' + data.message);
                    setTimeout(() => { loadReports(); loadStats(); }, 5000);
                } else {
                    alert('‚ùå L·ªói: ' + data.message);
                }
            } catch (error) {
                alert('Connection Error: ' + error.message);
            } finally {
                btn.disabled = false;
                gBtn.disabled = false;
                btn.innerHTML = originalText;
                gBtn.innerHTML = originalGText;
            }
        }

        // --- 6. Pricing Strategy Logic (Phase 6) ---
        async function calcPricing() {
            const input = document.getElementById('pricing-input');
            const btn = document.getElementById('btn-calc-pricing');
            const categorySelect = document.getElementById('pricing-category');
            const resultDiv = document.getElementById('pricing-result');
            const emptyDiv = document.getElementById('pricing-empty');
            const loadingDiv = document.getElementById('pricing-loading');
            const markdownResult = document.getElementById('markdown-result');
            const modeBadge = document.getElementById('pricing-mode-badge');

            const query = input.value.trim();
            if (!query) { alert("Vui l√≤ng nh·∫≠p t√™n s√°ch!"); return; }
            const category = categorySelect ? categorySelect.value : 'default';

            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin">üåÄ</span> ƒêang t√≠nh...';
            emptyDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            markdownResult.classList.add('hidden');
            modeBadge.classList.add('hidden');

            try {
                const response = await fetch(`/api/price-strategy/suggest?q=${encodeURIComponent(query)}&category=${encodeURIComponent(category)}`);
                const data = await response.json();

                if (data.error || !data.tier1) {
                    loadingDiv.classList.add('hidden');
                    emptyDiv.classList.remove('hidden');
                    emptyDiv.innerHTML = `<div class="text-4xl mb-2 opacity-30">üîç</div><p class="text-red-400">${data.error || 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu gi√°.'}</p>`;
                    return;
                }

                const fmt = v => v ? new Intl.NumberFormat('vi-VN').format(v) + ' ‚Ç´' : 'N/A';

                // Pricing mode badge
                const modeColors = {
                    'standard': 'bg-green-50 text-green-700 border border-green-200',
                    'scarcity': 'bg-yellow-50 text-yellow-700 border border-yellow-200',
                    'ultra_rare': 'bg-red-50 text-red-700 border border-red-200',
                };
                modeBadge.className = `mb-4 px-4 py-2 rounded-lg text-sm font-medium ${modeColors[data.pricing_mode] || ''}`;
                modeBadge.textContent = data.pricing_mode_label || '';
                modeBadge.classList.remove('hidden');

                document.getElementById('pricing-tier1-price').textContent = fmt(data.tier1.price);
                document.getElementById('pricing-tier1-ratio').textContent = data.tier1.ratio_pct ? `${data.tier1.ratio_pct}% gi√° tham chi·∫øu` : 'üíé S√°ch hi·∫øm';
                document.getElementById('pricing-tier1-label').textContent = data.tier1.label;
                document.getElementById('pricing-tier1-strategy').textContent = data.market_price
                    ? `Gi√° tham chi·∫øu (${data.market_source}): ${fmt(data.market_price)}`
                    : `Ngu·ªìn: ${data.market_source}`;

                document.getElementById('pricing-tier2-price').textContent = fmt(data.tier2.price);
                document.getElementById('pricing-tier2-ratio').textContent = data.tier2.ratio_pct ? `${data.tier2.ratio_pct}% gi√° tham chi·∫øu` : '‚ö° Tho√°t kho';
                document.getElementById('pricing-tier2-label').textContent = data.tier2.label;

                document.getElementById('pricing-recommendation').innerHTML = `üí° <strong>G·ª£i √Ω:</strong> ${data.recommendation}`;

                loadingDiv.classList.add('hidden');
                resultDiv.classList.remove('hidden');
            } catch (err) {
                console.error(err);
                loadingDiv.classList.add('hidden');
                emptyDiv.classList.remove('hidden');
                emptyDiv.innerHTML = `<p class="text-red-400">L·ªói: ${err.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üßÆ</span> T√≠nh gi√°';
                loadingDiv.classList.add('hidden');
            }
        }

        async function applyMarkdowns(dryRun) {
            const markdownResult = document.getElementById('markdown-result');
            const markdownList = document.getElementById('markdown-list');
            markdownResult.classList.remove('hidden');
            markdownList.innerHTML = '<p class="text-gray-400 text-center py-4">‚è≥ ƒêang qu√©t kho h√†ng...</p>';

            try {
                const response = await fetch(`/api/price-strategy/apply-markdowns?dry_run=${dryRun}`, { method: 'POST' });
                const data = await response.json();

                if (data.total_stale === 0) {
                    markdownList.innerHTML = '<p class="text-green-600 text-center py-4">‚úÖ Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o t·ªìn kho qu√° 30 ng√†y!</p>';
                    return;
                }

                const action = dryRun ? 'Xem tr∆∞·ªõc' : 'ƒê√£ gi·∫£m gi√°';
                const items = data.markdowns.map(item =>
                    `<div class="flex justify-between py-2 border-b border-gray-100 italic">
                        <span class="text-gray-700 font-medium">${item.title}</span>
                        <span class="text-orange-600 font-bold">${new Intl.NumberFormat('vi-VN').format(item.old_price)}ƒë ‚Üí ${new Intl.NumberFormat('vi-VN').format(item.new_price)}ƒë</span>
                    </div>`
                ).join('');

                markdownResult.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-gray-700 flex items-center gap-2">üìù K·∫øt qu·∫£ x·ª≠ l√Ω h√†ng t·ªìn (${action})</h3>
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">${data.total_marked_down}/${data.total_stale} SP</span>
                    </div>
                    <div class="space-y-1 max-h-60 overflow-y-auto pr-2 bg-white rounded-lg p-3 border border-gray-100 shadow-inner">
                        ${items}
                    </div>
                    ${!dryRun ? '<p class="text-green-600 mt-3 text-xs font-bold">‚úÖ ƒê√£ c·∫≠p nh·∫≠t gi√° tr√™n Haravan & g·ª≠i b√°o c√°o Telegram!</p>' : '<p class="text-orange-500 mt-3 text-xs font-bold">‚ö†Ô∏è Nh·∫•n "√Åp d·ª•ng gi·∫£m gi√° T·∫ßng 2 ngay" ƒë·ªÉ th·ª±c hi·ªán thay ƒë·ªïi th·ª±c t·∫ø.</p>'}
                `;
            } catch (err) {
                markdownList.innerHTML = `<p class="text-red-400">L·ªói: ${err.message}</p>`;
            }
        }

        async function loadPricingHistory() {
            const section = document.getElementById('pricing-history-section');
            const list = document.getElementById('pricing-history-list');
            section.classList.remove('hidden');
            list.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-400">ƒêang t·∫£i l·ªãch s·ª≠...</td></tr>';

            try {
                const response = await fetch('/api/price-strategy/history');
                const data = await response.json();

                if (!data.history || data.history.length === 0) {
                    list.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-400">Tr·ªëng (ch∆∞a c√≥ ghi nh·∫≠n chuy·ªÉn t·∫ßng gi√°)</td></tr>';
                    return;
                }

                list.innerHTML = data.history.map(h => `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-3 text-gray-500 font-mono">${h.transitioned_at.split(' ')[1]}<br><span class="text-[10px]">${h.transitioned_at.split(' ')[0]}</span></td>
                        <td class="py-3 font-medium text-gray-700">${h.title}</td>
                        <td class="py-3">
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold ${h.from_tier == 1 ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-600'}">T${h.from_tier || '?'}</span>
                            <span class="mx-1 text-gray-300">‚Üí</span>
                            <span class="px-2 py-1 rounded-full bg-orange-100 text-orange-700 text-[10px] font-bold">T${h.to_tier}</span>
                        </td>
                        <td class="py-3 text-gray-400 line-through">${new Intl.NumberFormat('vi-VN').format(h.old_price)}ƒë</td>
                        <td class="py-3 text-indigo-600 font-bold">${new Intl.NumberFormat('vi-VN').format(h.new_price)}ƒë</td>
                    </tr>
                `).join('');
            } catch (err) {
                list.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-red-400">L·ªói: ${err.message}</td></tr>`;
            }
        }

        document.getElementById('pricing-input')?.addEventListener('keypress', e => {
            if (e.key === 'Enter') calcPricing();
        });

        async function loadBundleSuggestions() {
            const list = document.getElementById('bundle-suggestions-list');
            const loading = document.getElementById('bundle-loading');
            const btn = document.getElementById('btn-load-bundles');

            btn.disabled = true;
            list.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                const response = await fetch('/api/price-strategy/bundle-suggestions');
                const data = await response.json();

                if (!data.suggestions || data.suggestions.length === 0) {
                    list.innerHTML = `<div class="col-span-full py-10 text-center text-gray-400">‚úÖ Hi·ªán ch∆∞a ƒë·ªß s√°ch c√πng th·ªÉ lo·∫°i ·ªü T·∫ßng 2 ƒë·ªÉ t·∫°o Combo.</div>`;
                } else {
                    list.innerHTML = data.suggestions.map((s, idx) => `
                        <div class="border border-gray-100 bg-gray-50 rounded-xl p-4 flex flex-col">
                            <div class="flex justify-between items-start mb-3">
                                <span class="bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold uppercase">Combo ${s.items_count} cu·ªën</span>
                                <span class="text-xs text-gray-400">${s.label}</span>
                            </div>
                            <div class="flex -space-x-4 mb-4 overflow-hidden">
                                ${s.items.map(item => `
                                    <img src="${item.image || 'https://via.placeholder.com/100'}" class="w-12 h-16 object-cover border-2 border-white rounded shadow-sm" title="${item.title}">
                                `).join('')}
                            </div>
                            <div class="mt-auto">
                                <div class="flex justify-between items-end mb-3">
                                    <div>
                                        <div class="text-[10px] text-gray-400 line-through">${new Intl.NumberFormat('vi-VN').format(s.original_price)}ƒë</div>
                                        <div class="text-sm font-bold text-indigo-600">${new Intl.NumberFormat('vi-VN').format(s.suggested_price)}ƒë</div>
                                    </div>
                                    <div class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded font-bold">-${s.discount_pct}% CLI·∫æT KH·∫§U</div>
                                </div>
                                <button onclick="createBundle(${JSON.stringify(s.items.map(i => i.id)).replace(/"/g, "'")}, '${s.label}', ${s.suggested_price}, this)" 
                                    class="w-full py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 transition-all shadow-sm">
                                    üöÄ Ph√°t h√†nh Combo ngay
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
                list.classList.remove('hidden');
            } catch (err) {
                list.innerHTML = `<div class="col-span-full text-red-400 text-sm">L·ªói: ${err.message}</div>`;
                list.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false;
            }
        }

        async function createBundle(itemIds, title, price, btn) {
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin">üåÄ</span> ƒêang t·∫°o...';

            try {
                const response = await fetch('/api/price-strategy/create-bundle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_ids: itemIds, title: title, price: price })
                });
                const data = await response.json();

                if (data.id) {
                    btn.className = "w-full py-2 bg-green-600 text-white rounded-lg text-xs font-bold";
                    btn.innerHTML = "‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng!";
                    setTimeout(() => {
                        window.open(`https://${window.location.hostname}/admin/products/${data.id}`, '_blank');
                    }, 1000);
                } else {
                    alert('L·ªói khi t·∫°o combo: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (err) {
                alert('Connection Error: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        async function syncBundles() {
            const btn = document.getElementById('btn-sync-bundles');
            btn.disabled = true;
            btn.innerHTML = 'üîÑ ƒêang ƒë·ªìng b·ªô...';

            try {
                const response = await fetch('/api/price-strategy/sync-bundles', { method: 'POST' });
                const data = await response.json();
                if (data.error) {
                    alert('L·ªói ƒë·ªìng b·ªô: ' + data.error);
                } else {
                    alert(`‚úÖ Ho√†n t·∫•t! ƒê√£ ki·ªÉm tra ${data.total} combo, c·∫≠p nh·∫≠t ${data.updated} combo.`);
                }
            } catch (err) {
                alert('L·ªói k·∫øt n·ªëi: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ ƒê·ªìng b·ªô t·ªìn kho';
            }
        }

        // --- 5. Price Scout Logic (Phase 5) ---
        async function scoutPrice() {
            const input = document.getElementById('price-search-input');
            const btn = document.getElementById('btn-scout-price');
            const resultsDiv = document.getElementById('price-results');
            const resultsBody = document.getElementById('price-results-body');
            const emptyDiv = document.getElementById('price-scout-empty');
            const loadingDiv = document.getElementById('price-scout-loading');

            const query = input.value.trim();
            if (!query) {
                alert("Vui l√≤ng nh·∫≠p t√™n s√°ch!");
                return;
            }

            // UI States
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin">üåÄ</span> ƒêang t√¨m...';
            emptyDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');

            try {
                const response = await fetch(`/api/compare-price?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    loadingDiv.classList.add('hidden');
                    emptyDiv.classList.remove('hidden');
                    emptyDiv.innerHTML = `<div class="text-5xl mb-3 grayscale opacity-30">üîç</div><p>Kh√¥ng t√¨m th·∫•y s√°ch "${query}" tr√™n c√°c s√†n.</p>`;
                    return;
                }

                // Render Results
                resultsBody.innerHTML = data.results.map(item => `
                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                        <td class="py-4 px-4">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${item.platform === 'Tiki' ? 'bg-blue-100 text-blue-700' :
                        item.platform === 'Fahasa' ? 'bg-red-100 text-red-700' :
                            'bg-emerald-100 text-emerald-700'
                    }">
                                ${item.platform}
                            </span>
                            <div class="text-[10px] text-gray-400 mt-1">${item.type}</div>
                        </td>
                        <td class="py-4 px-4">
                            <div class="flex items-center gap-3">
                                ${item.thumbnail ? `<img src="${item.thumbnail}" class="w-10 h-10 object-cover rounded shadow-sm">` : '<div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center text-xs">üìñ</div>'}
                                <div class="font-medium text-gray-800 text-sm line-clamp-2">${item.title}</div>
                            </div>
                        </td>
                        <td class="py-4 px-4 text-right">
                            <div class="font-bold text-gray-900">${new Intl.NumberFormat('vi-VN').format(item.price)} ‚Ç´</div>
                        </td>
                        <td class="py-4 px-4 text-right">
                            <a href="${item.link}" target="_blank" class="inline-block px-3 py-1 bg-gray-100 text-gray-600 rounded-lg text-xs hover:bg-blue-600 hover:text-white transition-all">
                                Xem ngay ‚Üí
                            </a>
                        </td>
                    </tr>
                `).join('');

                loadingDiv.classList.add('hidden');
                resultsDiv.classList.remove('hidden');

            } catch (error) {
                console.error("Price Scout Error:", error);
                loadingDiv.classList.add('hidden');
                emptyDiv.classList.remove('hidden');
                emptyDiv.innerHTML = `<p class="text-red-500">L·ªói k·∫øt n·ªëi: ${error.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üöÄ</span> So s√°nh ngay';
            }
        }

        // Support Enter key for search
        document.getElementById('price-search-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                scoutPrice();
            }
        });

        // --- 3. SSE Live Updates Logic ---
        function connectSSE() {
            const eventSource = new EventSource('/api/events');
            const liveBar = document.getElementById('live-activity-bar');
            const liveMsg = document.getElementById('live-message');

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);
                console.log("SSE Event:", data);

                if (data.type === 'api_progress' || data.type === 'agent_status') {
                    liveMsg.textContent = data.message;
                    liveBar.classList.remove('bg-yellow-50', 'text-yellow-800');
                    liveBar.classList.add('bg-blue-50', 'text-blue-800');

                    // Specific logic for different agents if needed
                    if (data.type === 'agent_status' && data.message.includes('Success')) {
                        setTimeout(() => {
                            liveBar.classList.remove('bg-blue-50', 'text-blue-800');
                            liveBar.classList.add('bg-green-50', 'text-green-800');
                        }, 1000);
                    }
                }
            };

            eventSource.onerror = function (err) {
                console.error("SSE Error:", err);
                liveMsg.textContent = "M·∫•t k·∫øt n·ªëi Live Update. ƒêang th·ª≠ l·∫°i...";
                liveBar.classList.add('bg-red-50', 'text-red-800');
                eventSource.close();
                setTimeout(connectSSE, 5000);
            };
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadReports();
            loadStats();
            connectSSE();
        });

    </script>
</body>

</html>