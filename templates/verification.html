<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mecobooks AI Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 6px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }

        .report-content h1 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .report-content h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .report-content h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 0.75rem;
        }

        .report-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.75rem 0;
            font-size: 0.8rem;
        }

        .report-content th,
        .report-content td {
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            text-align: left;
        }

        .report-content th {
            background: #f3f4f6;
            font-weight: 600;
        }

        .report-content tr:hover {
            background: #f9fafb;
        }

        .report-content ul,
        .report-content ol {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        .report-content li {
            margin-bottom: 0.25rem;
        }

        .report-content p {
            margin-bottom: 0.5rem;
        }

        .report-content pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.8rem;
        }

        .card {
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .report-item {
            cursor: pointer;
            transition: all 0.15s;
        }

        .report-item:hover {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .btn {
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none !important;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex !important;
        }

        .badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: 500;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-900 text-white hidden md:flex flex-col">
            <div class="p-6 border-b border-gray-800 flex items-center gap-3">
                <span class="text-2xl">ü§ñ</span>
                <div>
                    <h1 class="font-bold text-lg tracking-wide">Mecobooks AI</h1>
                    <p class="text-xs text-gray-500">Admin Dashboard v2.0</p>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#"
                    class="flex items-center gap-3 px-4 py-3 bg-gray-800 text-white rounded-lg transition-colors">
                    <span>üìä</span> Overview
                </a>
                <a href="#agents"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <span>‚ö°</span> AI Agents
                </a>
                <a href="#reports"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <span>üìã</span> Reports
                </a>
                <a href="https://mecobooks.com/wp-admin" target="_blank"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <span>üõí</span> WordPress Admin
                </a>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <div id="server-status" class="flex items-center gap-2 text-xs text-gray-500">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    Server Online
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gray-50">
            <header
                class="bg-white border-b border-gray-200 px-8 py-4 flex justify-between items-center sticky top-0 z-10">
                <h2 class="text-xl font-bold text-gray-800">Dashboard Overview</h2>
                <div class="flex items-center gap-4">
                    <button onclick="loadStats()" class="text-gray-500 hover:text-gray-700 transition">
                        üîÑ Refresh
                    </button>
                    <div
                        class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold border border-blue-200">
                        A
                    </div>
                </div>
            </header>

            <div class="px-8 py-8 max-w-7xl mx-auto space-y-8">

                <!-- KPI Section -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Revenue -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Doanh thu (Th√°ng)
                                </p>
                                <h3 class="text-2xl font-bold text-gray-900 mt-1" id="kpi-revenue">---</h3>
                            </div>
                            <span class="p-2 bg-green-100 text-green-600 rounded-lg">üí∞</span>
                        </div>
                        <p class="text-xs text-green-600 flex items-center gap-1">
                            <span>‚Üë 12%</span> <span class="text-gray-400">vs th√°ng tr∆∞·ªõc</span>
                        </p>
                    </div>

                    <!-- Orders -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">ƒê∆°n h√†ng m·ªõi</p>
                                <h3 class="text-2xl font-bold text-gray-900 mt-1" id="kpi-orders">---</h3>
                            </div>
                            <span class="p-2 bg-blue-100 text-blue-600 rounded-lg">üì¶</span>
                        </div>
                        <p class="text-xs text-gray-400">ƒê∆°n h√†ng ho√†n t·∫•t</p>
                    </div>

                    <!-- System Health (CPU) -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">CPU Server</p>
                                <h3 class="text-2xl font-bold text-gray-900 mt-1" id="kpi-cpu">---%</h3>
                            </div>
                            <span class="p-2 bg-purple-100 text-purple-600 rounded-lg">üñ•Ô∏è</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                            <div class="bg-purple-500 h-1.5 rounded-full" id="bar-cpu" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- System Health (RAM) -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">RAM Usage</p>
                                <h3 class="text-2xl font-bold text-gray-900 mt-1" id="kpi-ram">---%</h3>
                            </div>
                            <span class="p-2 bg-yellow-100 text-yellow-600 rounded-lg">üíæ</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                            <div class="bg-yellow-500 h-1.5 rounded-full" id="bar-ram" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 col-span-2">
                        <h3 class="font-bold text-gray-800 mb-4">Bi·ªÉu ƒë·ªì Doanh thu (Demo)</h3>
                        <canvas id="salesChart" height="120"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4">Tr·∫°ng th√°i T·ªìn kho (Demo)</h3>
                        <div class="relative h-48">
                            <canvas id="inventoryChart"></canvas>
                        </div>
                        <div class="mt-4 space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">C√≤n h√†ng</span>
                                <span class="font-medium text-gray-900">85%</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">H·∫øt h√†ng</span>
                                <span class="font-medium text-gray-900">15%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-200">

                <!-- Agents Section -->
                <div id="agents">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        ‚ö° Control Center - AI Agents
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Content Creator -->
                        <div
                            class="card bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:border-purple-300 transition-all group">
                            <div class="flex justify-between items-start mb-3">
                                <div
                                    class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center text-xl">
                                    ‚úçÔ∏è</div>
                                <span class="badge bg-green-50 text-green-700 border border-green-100">Ready</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1 group-hover:text-purple-600 transition-colors">
                                Content Creator</h3>
                            <p class="text-xs text-gray-500 mb-4 h-8 overflow-hidden">Vi·∫øt caption, t·∫°o script video t·ª´
                                s·∫£n ph·∫©m</p>

                            <button onclick="runAgent('content_creator')" id="btn-content_creator"
                                class="w-full btn bg-gray-900 text-white px-4 py-2.5 rounded-lg hover:bg-black text-sm font-medium flex justify-center gap-2">
                                <span>‚ñ∂</span> Run Agent
                            </button>
                            <div id="res-content_creator"
                                class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-40 report-content border border-gray-100">
                            </div>
                        </div>

                        <!-- Market Research -->
                        <div
                            class="card bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:border-blue-300 transition-all group">
                            <div class="flex justify-between items-start mb-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-xl">
                                    üìà</div>
                                <span class="badge bg-green-50 text-green-700 border border-green-100">Ready</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1 group-hover:text-blue-600 transition-colors">Market
                                Research</h3>
                            <p class="text-xs text-gray-500 mb-4 h-8 overflow-hidden">Nghi√™n c·ª©u trend s√°ch, xu·∫•t Google
                                Sheets</p>

                            <button onclick="runAgent('market_research')" id="btn-market_research"
                                class="w-full btn bg-gray-900 text-white px-4 py-2.5 rounded-lg hover:bg-black text-sm font-medium flex justify-center gap-2">
                                <span>‚ñ∂</span> Run Agent
                            </button>
                            <div id="res-market_research"
                                class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-40 report-content border border-gray-100">
                            </div>
                        </div>

                        <!-- Inventory Analyst -->
                        <div
                            class="card bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:border-yellow-300 transition-all group">
                            <div class="flex justify-between items-start mb-3">
                                <div
                                    class="w-10 h-10 rounded-lg bg-yellow-100 flex items-center justify-center text-xl">
                                    üì¶</div>
                                <span class="badge bg-green-50 text-green-700 border border-green-100">Ready</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1 group-hover:text-yellow-600 transition-colors">
                                Inventory Analyst</h3>
                            <p class="text-xs text-gray-500 mb-4 h-8 overflow-hidden">Ph√¢n t√≠ch t·ªìn kho ABC, l·∫≠p k·∫ø
                                ho·∫°ch nh·∫≠p h√†ng</p>

                            <button onclick="runAgent('inventory_analyst')" id="btn-inventory_analyst"
                                class="w-full btn bg-gray-900 text-white px-4 py-2.5 rounded-lg hover:bg-black text-sm font-medium flex justify-center gap-2">
                                <span>‚ñ∂</span> Run Agent
                            </button>
                            <div id="res-inventory_analyst"
                                class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-40 report-content border border-gray-100">
                            </div>
                        </div>

                        <!-- Integrity Manager -->
                        <div
                            class="card bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:border-red-300 transition-all group">
                            <div class="flex justify-between items-start mb-3">
                                <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center text-xl">
                                    üõ°Ô∏è</div>
                                <span class="badge bg-green-50 text-green-700 border border-green-100">Ready</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1 group-hover:text-red-600 transition-colors">
                                Integrity Manager</h3>
                            <p class="text-xs text-gray-500 mb-4 h-8 overflow-hidden">Ki·ªÉm tra Disk, Memory, Server
                                health</p>

                            <button onclick="runAgent('integrity_manager')" id="btn-integrity_manager"
                                class="w-full btn bg-gray-900 text-white px-4 py-2.5 rounded-lg hover:bg-black text-sm font-medium flex justify-center gap-2">
                                <span>‚ñ∂</span> Run Agent
                            </button>
                            <div id="res-integrity_manager"
                                class="mt-3 hidden p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-40 report-content border border-gray-100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">üìã B√°o c√°o ƒë√£ l∆∞u</h2>
                            <p class="text-sm text-gray-400">L·ªãch s·ª≠ ho·∫°t ƒë·ªông c·ªßa c√°c Agent</p>
                        </div>
                        <button onclick="loadReports()" id="btn-load-reports"
                            class="btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium border border-gray-200">
                            üîÑ T·∫£i l·∫°i
                        </button>
                    </div>

                    <div id="reports-list" class="space-y-3"></div>
                    <div id="reports-empty"
                        class="hidden text-center text-gray-400 py-12 text-sm bg-gray-50 rounded-lg border border-dashed border-gray-200">
                        <span class="text-4xl block mb-2">üì≠</span>
                        Ch∆∞a c√≥ b√°o c√°o n√†o. H√£y ch·∫°y Agent ·ªü tr√™n!
                    </div>
                </div>
            </div>

            <footer class="text-center text-xs text-gray-400 py-8 border-t border-gray-200 mt-8">
                Mecobooks AI System v2.1 ¬© 2026 ‚Ä¢ Powered by Antigravity
            </footer>
        </main>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden mx-4 flex flex-col"
            onclick="event.stopPropagation()">
            <div class="flex items-center justify-between px-6 py-4 border-b bg-gray-50 shrink-0">
                <div class="flex-1">
                    <h3 id="modal-title" class="font-bold text-gray-900 text-lg"></h3>
                    <p id="modal-date" class="text-xs text-gray-500"></p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btn-gen-video"
                        class="hidden bg-purple-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-purple-700 transition flex items-center gap-2">
                        üéûÔ∏è T·∫°o Video TikTok/Reels
                    </button>
                    <button onclick="document.getElementById('report-modal').classList.remove('active')"
                        class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 hover:bg-gray-300 flex items-center justify-center transition">‚úï</button>
                </div>
            </div>
            <div id="modal-content" class="p-8 overflow-auto report-content flex-1 max-h-[80vh]"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- 1. Stats & Charts Logic ---

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();

                if (data.system) {
                    document.getElementById('kpi-cpu').textContent = (data.system.cpu || 0) + '%';
                    document.getElementById('bar-cpu').style.width = (data.system.cpu || 0) + '%';

                    document.getElementById('kpi-ram').textContent = (data.system.memory || 0) + '%';
                    document.getElementById('bar-ram').style.width = (data.system.memory || 0) + '%';
                }

                if (data.business) {
                    const rev = parseInt(data.business.sales_total || 0).toLocaleString('vi-VN');
                    document.getElementById('kpi-revenue').textContent = rev + ' ƒë';
                    document.getElementById('kpi-orders').textContent = data.business.orders_count || 0;

                    // Update Chart (Mock Data if real data is single point, or implement historical API later)
                    updateCharts(data.business);
                }

            } catch (e) {
                console.error("Load Stats Error:", e);
            }
        }

        let salesChartInstance = null;
        let inventoryChartInstance = null;

        function updateCharts(bizData) {
            const ctxSales = document.getElementById('salesChart').getContext('2d');
            const ctxInv = document.getElementById('inventoryChart').getContext('2d');

            // --- Sales Chart ---
            const labels = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
            // Mock trend based on total
            const total = parseInt(bizData.sales_total || 0);
            const dataPoints = [total * 0.1, total * 0.15, total * 0.12, total * 0.2, total * 0.08, total * 0.25, total * 0.1];

            if (salesChartInstance) salesChartInstance.destroy();

            salesChartInstance = new Chart(ctxSales, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu (VNƒê)',
                        data: dataPoints,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                }
            });

            // --- Inventory Chart ---
            if (inventoryChartInstance) inventoryChartInstance.destroy();

            inventoryChartInstance = new Chart(ctxInv, {
                type: 'doughnut',
                data: {
                    labels: ['C√≤n h√†ng', 'H·∫øt h√†ng', 'ƒê·∫∑t tr∆∞·ªõc'],
                    datasets: [{
                        data: [85, 10, 5], // Mock distribution for now
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    cutout: '70%'
                }
            });
        }

        // --- 2. Existing Reports & Agents Logic ---

        async function loadReports() {
            const btn = document.getElementById('btn-load-reports');
            const list = document.getElementById('reports-list');
            const empty = document.getElementById('reports-empty');

            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> ...';

            try {
                const response = await fetch('/api/reports');
                const data = await response.json();

                if (!data.reports || data.reports.length === 0) {
                    list.innerHTML = '';
                    empty.classList.remove('hidden');
                    return;
                }

                empty.classList.add('hidden');

                const icons = { 'Market Research': 'üìà', 'Inventory Report': 'üì¶', 'Integrity Report': 'üõ°Ô∏è' };
                const colors = { 'Market Research': 'blue', 'Inventory Report': 'yellow', 'Integrity Report': 'red' }; // Unused but kept for logic

                list.innerHTML = data.reports.map(r => {
                    const icon = icons[r.name] || 'üìÑ';
                    const color = colors[r.name] || 'gray';
                    return `
                        <div class="report-item bg-gray-50 border border-gray-100 rounded-lg p-4 flex items-center justify-between hover:bg-white hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group"
                             onclick="viewReport('${r.id}', '${r.name}')">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-xl shadow-sm group-hover:scale-110 transition-transform">${icon}</div>
                                <div>
                                    <p class="font-bold text-gray-800 text-sm group-hover:text-blue-600 transition-colors">${r.name}</p>
                                    <p class="text-xs text-gray-400">ID: ${r.id} ‚Ä¢ C·∫≠p nh·∫≠t: ${r.modified} ‚Ä¢ ${r.size_kb} KB</p>
                                </div>
                            </div>
                            <span class="text-gray-300 text-lg group-hover:text-blue-500 transition-colors">View ‚Üí</span>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                list.innerHTML = `<p class="text-red-500 text-sm">L·ªói: ${error.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ T·∫£i l·∫°i';
            }
        }

        let currentReportId = null;

        async function viewReport(reportId, name) {
            const modal = document.getElementById('report-modal');
            const title = document.getElementById('modal-title');
            const date = document.getElementById('modal-date');
            const content = document.getElementById('modal-content');

            currentReportId = reportId;
            title.textContent = name;
            date.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu...';

            // Handle Video Button
            const btnGen = document.getElementById('btn-gen-video');
            if (btnGen) {
                btnGen.classList.add('hidden');
                btnGen.innerHTML = 'üéûÔ∏è T·∫°o Video TikTok/Reels';
                btnGen.classList.remove('bg-green-600');
                btnGen.classList.add('bg-purple-600');
                btnGen.disabled = false;
                btnGen.classList.remove('opacity-50', 'cursor-not-allowed');
                btnGen.onclick = () => generateVideo(reportId);
            }

            content.innerHTML = '<div class="flex justify-center py-12"><span class="loader" style="width: 32px; height: 32px; border-width: 4px; border-color: #e5e7eb; border-top-color: #3b82f6;"></span></div>';
            modal.classList.add('active');

            try {
                const response = await fetch(`/api/reports/${reportId}`);
                const data = await response.json();

                date.textContent = `ID: ${reportId} ‚Ä¢ C·∫≠p nh·∫≠t: ${data.modified}`;

                if (!data.content || data.content.trim() === '') {
                    content.innerHTML = '<div class="text-center py-12 text-gray-400 flex flex-col items-center"><span class="text-5xl mb-3 grayscale opacity-50">üìÑ</span><p>B√°o c√°o n√†y ch∆∞a c√≥ n·ªôi dung.</p></div>';
                } else {
                    content.innerHTML = marked.parse(data.content);

                    // Show Video Button if it's a Content Creator report
                    if (name.toLowerCase().includes('content') && btnGen) {
                        btnGen.classList.remove('hidden');
                    }
                }
            } catch (error) {
                content.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-lg">‚ùå L·ªói: ${error.message}</div>`;
            }
        }

        async function generateVideo(reportId) {
            const btn = document.getElementById('btn-gen-video');
            if (!btn) return;

            if (!confirm('B·∫Øt ƒë·∫ßu t·∫°o Video t·ª´ k·ªãch b·∫£n n√†y? Qu√° tr√¨nh x·ª≠ l√Ω m·∫•t kho·∫£ng 30-60 gi√¢y.')) return;

            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.innerHTML = '<span class="loader"></span> ƒêang t·∫°o...';

            try {
                const response = await fetch(`/api/generate-video/${reportId}`, { method: 'POST' });
                const data = await response.json();

                if (data.status === 'success') {
                    btn.innerHTML = '‚úÖ Video Xong!';
                    btn.classList.remove('bg-purple-600');
                    btn.classList.add('bg-green-600');

                    // Show link in modal
                    const videoDiv = document.createElement('div');
                    videoDiv.className = 'mt-6 p-4 bg-green-50 border border-green-200 rounded-xl flex flex-col items-center gap-3';
                    videoDiv.innerHTML = `
                        <p class="text-green-800 font-bold text-sm">üéâ Video ƒë√£ ƒë∆∞·ª£c t·∫°o v√† g·ª≠i qua Telegram!</p>
                        <video controls class="w-full max-w-sm rounded-lg shadow-lg">
                            <source src="${data.video_url}" type="video/mp4">
                        </video>
                        <a href="${data.video_url}" target="_blank" class="text-blue-600 underline text-xs">M·ªü video trong tab m·ªõi</a>
                    `;
                    document.getElementById('modal-content').prepend(videoDiv);

                } else {
                    alert('L·ªói: ' + data.message);
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = originalHtml;
                }
            } catch (error) {
                alert('Connection Error: ' + error.message);
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerHTML = originalHtml;
            }
        }

        function closeModal(e) {
            if (e.target === e.currentTarget) {
                document.getElementById('report-modal').classList.remove('active');
                // Cleanup video button
                const btn = document.getElementById('btn-gen-video');
                if (btn) btn.remove();
            }
        }

        async function runAgent(agentName) {
            const btn = document.getElementById(`btn-${agentName}`);
            const res = document.getElementById(`res-${agentName}`);

            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loader"></span> Processing...';
            res.classList.add('hidden');

            try {
                const response = await fetch(`/run-agent-sync/${agentName}`, { method: 'POST' });
                const data = await response.json();

                let outputHtml = '';
                const now = new Date().toLocaleString('vi-VN');

                if (data.status === 'success') {
                    outputHtml = `<p class="text-green-600 font-bold mb-2 text-xs">‚úÖ Success ‚Ä¢ ${now}</p>`;
                    if (typeof data.output === 'string') {
                        outputHtml += marked.parse(data.output);
                    } else if (typeof data.output === 'object') {
                        outputHtml += `<pre class="text-xs bg-gray-100 p-2 rounded">${JSON.stringify(data.output, null, 2)}</pre>`;
                    }
                    // Auto reload stats and reports if agent succeeds (likely updated something)
                    setTimeout(() => { loadStats(); loadReports(); }, 2000);
                } else {
                    outputHtml = `<span class="text-red-600 font-bold">‚ùå Error: ${data.message}</span>`;
                }

                res.innerHTML = outputHtml;
                res.classList.remove('hidden');

            } catch (error) {
                res.innerHTML = `<span class="text-red-600 font-bold">‚ùå Network Error: ${error.message}</span>`;
                res.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadReports();
            loadStats();
        });

    </script>
</body>

</html>